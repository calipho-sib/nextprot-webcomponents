<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<script src="../nextprot-js/dist/nextprot.bundle.js"></script>
<script src="../d3/d3.min.js"></script>
<script src="../bootstrap/js/tooltip.js"></script>
<script src="../bootstrap/js/tab.js"></script>
<link rel="stylesheet" type="text/css" href="../bootstrap/dist/css/bootstrap.min.css" async>
<!--
`isoform-selector`
Widget visualizing isoform sequence coverage, allows switching between isoforms.
@demo demo/index.html
-->
<dom-module id="isoform-selector">
  <template>
  <style is="isoform-selector-style">
    :host {
      display: block;
    }
    .navbar-brand {
      padding: 10px 15px;
      color:#C50063;
      height:auto;
      font-size:20px;
    }
    .nav {
      border:none;
    }
    .dropdown {
      z-index:20;
    }
    #otherIsoformsTab {
      pointer-events:none;
      cursor:default;
      padding: 3px 20px;
    }
    #isoformMap {
      color:#007800;
      font-size:16px;
      padding-top: 8px;
    }
  </style>
    <div id="nx-isoformChoice" class="col-md-12" style="margin-bottom: -5px;">
    <div role="tab-panel">
      <div class="navbar-brand">Isoforms</div>
      <ul class="nav nav-tabs" role="tablist">
          <template is="dom-repeat" items="{{isoforms.visible}}" as="isoform">
            <li role="presentation">
              <a class="isoformNames" href="#{{isoform.uniqueName}}" role="tab" data-toggle="tab" title="{{isoform.mainEntityName.value}}">{{isoform.uniqueName}}</a>
            </li>
          </template>
        <template id="menu" is="dom-if" if="{{isoforms.more}}">
          <li role="presentation" class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-expanded="false">
              <span id="extendIsoformChoice">More</span><span style="margin-left:5px;" class="caret"></span>
            </a>
          </li>
          <ul id="moreIsoforms" class="dropdown-menu" role="menu">
            <li role="presentation"><p id="otherIsoformsTab" href="#" role="tab" data-toggle="tab">Others
              Isoforms</p></li>
            <template id="menu" is="dom-repeat" items="{{isoforms.more}}">
              <li role="presentation">
                <a class="isoformNames" href="#{{uniqueName}}" role="tab" data-toggle="tab" title="{{mainEntityName.value}}">{{uniqueName}}</a>
              </li>
            </template>
          </ul>
        </template>
        <li><a id="isoformMap" on-tap="toggleIsoformMap">See isoforms</a></li>
      </ul>
    </div>
    </div>
    <div class="row" style="margin: 0px 20px;">
      <div id="visuContainer" class="col-md-12">
        <iron-collapse id="isoformMapContainer" opened="{{showIsoformMap}}">
          <div id="isoformDisplayed"></div>
        </iron-collapse>
        <div id="chart"></div>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'isoform-selector',
      properties: {
        isoforms: {
          type: Object
        },
        sequences: {
          type: Object
        },
        isoformMapping: {
          type: Object
        },
        isoName: {
          type: String
        },
        /*featuresForViewer: {
          type: Array,
          value: []
        },
        featuresByIsoform: {
          type: Array,
          value: []
        },
        ft:{
          value: {
            onFeatureSelected: function(callback) {
              $(".featPosition").click(function() {
                var currentId = $(this).parent().parent().attr("id");
                var idParsed = currentId.split("_").slice(1).map(Number);
                var position = {
                  start: idParsed[0],
                  end: idParsed[1]
                }
                callback(position);
              });
            }
          }
        },*/
        showIsoformMap: {
          type: Boolean
        }
      },
      created: function(){
        var nx = new Nextprot.Client("neXtprot isoform selector", "Calipho Group");
        var nxEntry = nx.getEntryName();
        this.isoName = nxEntry+"-1";
        var self=this;
        nx.getIsoformMapping(nxEntry).then(
          function(data){
            self.isoforms=data;
            self.isoformMapping = self.testAlgoObject(data);
          }
        ).catch(function (err) {
          // catch any error that happened so far
          console.log("Argh, broken: " + err.message);
          console.log("Error at line : " + err.stack);
        });
        nx.getProteinSequence(nxEntry).then(
          function (data) {
            self.sequences = data;
            self.initialize();
          }
        ).catch(function (err) {
          // catch any error that happened so far
          console.log("Argh, broken: " + err.message);
          console.log("Error at line : " + err.stack);
        });

      },
      initialize: function () {
        this.nxIsoformChoice(this.sequences[0]);
        iFrameWidth =$("#visuContainer").width();
        for (var i=1; i<this.sequences.length-1;i++) {
          var feat = NXUtils.convertMappingsToIsoformMap(this.sequences[i],metaData[i].name,metaData[i].filter, "");
          featuresByIsoform.push(feat);
          var featForViewer = NXViewerUtils.convertNXAnnotations(feat,metaData[i]);
          this.featuresForViewer.push(featForViewer);
        }
        this.displayIsoform(this.isoformMapping,"#isoformDisplayed",this.isoName);
        //lines below go to triple viewer
        //this.addFiltering();
        //this.createSVG();
        //this.addFeatures();
        //this.fillTable();
        //this.tvSelection();
        //this.eventTV();
        //this.toggleFiltering();
      },
      reload: function (isoID) {
        //$("#chart svg").remove();
        //this.ft.clearInstance();
        //this.createSVG(this.isoforms,isoID);
        //this.addFeatures(isoID);
        //this.fillTable(isoID);
        //this.applyFiltering();
        //this.tvSelection();
        //this.eventTV();
        this.displayIsoform(this.isoformMapping,"#isoformDisplayed",isoID);

        // this goes to feature viewer
        //if ($(".zoomUnit").length) $(".zoomUnit").text("1");
        //d3.selectAll('div.selectedRect').remove();
      },
      nxIsoformChoice: function() {
        var self=this;
        if ($("#nx-isoformChoice").length > 0) {
          var datas = {
            "isoforms": (function () {
              var listIsoforms = {
                "visible": [],
                "more": []
              };
              self.sequences.sort(function (a, b) {
                return parseInt(a.uniqueName.split("-")[1]) - parseInt(b.uniqueName.split("-")[1])
              }).forEach(function (o, index) {
                if (index <= 3) listIsoforms.visible.push(o);
                else listIsoforms.more.push(o);
              });
              return listIsoforms;
            }())
          };
          this.isoName = datas.isoforms.visible[0].uniqueName;
          this.isoforms = datas.isoforms;
          /////////// EventListener to change isoform
          this.isoform;

          $(document).ready(function(){
            $('.isoformNames').tooltip({trigger: "hover"});
          });
          $("#nx-isoformChoice li:first-child").addClass("active");
        }
      },
      testAlgoObject: function(isoformsMap) {

        var isoformsMapping = Object.assign({}, isoformsMap);


        var positions=[];
        var decalage=[];
        // GET All positions x & y into new array positions
        for (var iso in isoformsMapping) {
          isoformsMapping[iso].positions.forEach(function (o) {
            positions.push(o.first, o.second);
          })
        }
        //delete double in list of positions
        positions = positions.filter(function(elem, index, self) {
          return index == self.indexOf(elem);});
        // sort positions
        positions.sort(function(a,b) {return a-b});

        //for each interval between position, check if there is something in isoforms
        //if not, add the empty interval to array decalage
        for (var i=0;i<positions.length-1;i++) {
          var presence = false;
          for (var j in this.isoforms) {
            for (var k in isoformsMapping[j].positions) {
              if (isoformsMapping[j].positions[k].first > positions[i+1]) break;
              else if (isoformsMapping[j].positions[k].first<= positions[i] && isoformsMapping[j].positions[k].second >= positions[i+1]) {
                presence=true;
                break;
              }
            }
            if (presence === true) break;
          }
          if (presence === false) decalage.push({x:positions[i],length:positions[i+1]-positions[i]});
        }
        ////For each "hole", apply a shift by adding the length of the hole to the values after the hole
        ////In the same time, if i[y] == i+1[x] merge those two
        for (var i=decalage.length-1;i>=0;i--) {
          for (var j in isoformsMapping) {
            for (var k=isoformsMapping[j].positions.length-1;k>=0;k--) {
              if (isoformsMapping[j].positions[k].first < decalage[i].x) {
                if (k !=isoformsMapping[j].positions.length-1 && i===0 && isoformsMapping[j].positions[k+1].first === isoformsMapping[j].positions[k].second) {
                  isoformsMapping[j].positions[k].second = isoformsMapping[j].positions[k+1].second;
                  isoformsMapping[j].positions.splice(k+1,1);
                }
                break;
              } else {
                isoformsMapping[j].positions[k].first -= decalage[i].length;
                isoformsMapping[j].positions[k].second -= decalage[i].length;
              }
              if (k !=isoformsMapping[j].positions.length-1 && isoformsMapping[j].positions[k+1].first === isoformsMapping[j].positions[k].second) {
                isoformsMapping[j].positions[k].second = isoformsMapping[j].positions[k+1].second;
                isoformsMapping[j].positions.splice(k+1,1);
              }
            }
          }
        }
        return isoformsMapping;
      },
      displayIsoform: function(array,divIsoform,isoIdentifier) {
        var isoContainer = this.$$(divIsoform + " #isoContainer")
        if(isoContainer) isoContainer.innerHTML="";
        if (!$('#isoContainer').length > 0) {
          $(divIsoform).append("<div id=\"isoContainer\"></div>");
        }
        function getMax(array) {
          var max = 0;
          for (name in array) {
            for (var pos in array[name].positions) {
              if (array[name].positions[pos].second > max) max = array[name].positions[pos].second;
            }
          }
          return max;
        }

        function getMin(array) {
          var min = 100000000;
          for (name in array) {
            for (var pos in array[name].positions) {
              if (array[name].positions[pos].first < min) min = array[name].positions[pos].first;
            }
          }
          return min;
        }

        var max = getMax(array);
        var min = getMin(array);
        var position = 20;


        var margin = {top: 10, right: 50, bottom: 0, left: 50},
                width = iFrameWidth - margin.left - margin.right - 17,
                height = 200 - margin.top - margin.bottom;
        var coverageLength = 33000;
        var scaling = d3.scaleLinear()
                .domain([min, max])
                .range([0, width]);

        var line = d3.line()
                .curve(d3.curveLinear)
                .x(function (d) {
                  return scaling(d.x);
                })
                .y(function (d) {
                  return d.y + 6;
                });

        var svgIso = d3.select(divIsoform + " #isoContainer").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .style("z-index", "2");
        var svgIsoform = svgIso
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var selectIsoform = function (iso) {
        };

        var self=this;

        function fillSVGIsoform(data) {
          var rectHeight = 12;
          var rectShift = 20;
          var rectsPro = svgIsoform.append("g")
                  .attr("class", "rectangle")
                  .attr("transform", "translate(0," + position + ")");

          rectsPro.append("path")
                  .attr("d", line([{x: min, y: 0}, {x: max, y: 0}]))
                  .attr("class", function () {
                    return "line"
                  })
                  .style("z-index", "0")
                  .style("stroke", "#C2DEC8")
                  .style("stroke-width", "1px");

          var rectsProGroup = rectsPro.selectAll("." + data.isoformAc + "Group")
                  .data(data.positions)
                  .enter()
                  .append("g")
                  .attr("class", data.isoformAc + "Group isoGroup")
                  .attr("transform", function (d) {
                    return "translate(" + scaling(d.first) + ",0)"
                  });

          rectsProGroup
                  .append("rect")
                  .attr("class", "element " + data.isoformAc + "Rect")
                  .attr("width", function (d) {
                    return (scaling(d.second) - scaling(d.first))
                  })
                  .attr("height", 12)
                  .style("fill", function () {
                    return data.isoformAc === isoIdentifier ? "#74EB78" : "#C2DEC8"
                  })
                  .style("z-index", "13")
                  .style("cursor", "pointer")
                  .on("click", function () {
                    svgIsoform.selectAll("rect").style("fill", "#C2DEC8");
                    d3.selectAll("." + data.isoformAc + "Rect").style("fill", "#74EB78");
                    //self.reload(data.isoformAc);
                    var isoSelection = $('#nx-isoformChoice a[href=#' + data.isoformAc + ']').tab('show');
                    if (isoSelection.parent().parent().is("#moreIsoforms")) $("#extendIsoformChoice").text(data.isoformAc);

                  });

          rectsProGroup
                  .append("text")
                  .attr("class", "element " + data.isoformAc + "Text")
                  .attr("y", 6)
                  .attr("dy", "0.35em")
                  .style("font-size", "10px")
                  .text(function (d) {
                    return data.isoformMainName
                  })
                  .style("fill", "black")
                  .style("z-index", "15")
                  .style("visibility", function (d) {
                    if (data.isoformMainName) {
                      return (scaling(d.second) - scaling(d.first)) > data.isoformMainName.length * 8 ? "visible" : "hidden";
                    }
                    else return "hidden";
                  });
          position += 20;
        }

        for (var name in array) {
          fillSVGIsoform(array[name], name);
        }
        $(window).resize(function () {
          updateIsoSVG();
        });

        function updateIsoSVG() {
          width = $(divIsoform).width() - margin.left - margin.right - 17;
          d3.select(divIsoform + " svg")
                  .attr("width", width + margin.left + margin.right);
          d3.select(divIsoform + " clippath>rect").attr("width", width);

          scaling.range([5, width - 5]);
          svgIsoform.selectAll(".line").attr("d", line([{x: min, y: 0}, {x: max, y: 0}]));
          svgIsoform.selectAll(".isoGroup").attr("transform", function (d) {
            return "translate(" + scaling(d.first) + ",0)"
          });
          svgIsoform.selectAll(".isoGroup rect").attr("width", function (d) {
            return (scaling(d.second) - scaling(d.first))
          });
          svgIsoform.selectAll(".isoGroup text").style("visibility", function (d) {
            var textContent = d3.select(this).text();
            if (textContent && textContent.length) {
              return (scaling(d.second) - scaling(d.first)) > textContent.length * 8 ? "visible" : "hidden";
            }
            else return "hidden";
          });
        }

        svgIso.attr("height", position + 10 + "px");
      },
      toggleIsoformMap: function() {
        this.$.isoformMapContainer.toggle();
      }
      /* should go to feature viewer
      addFiltering: function() {
      $("#chart").append("<div class=\"filter-block\" class=\"row\" style=\"margin:0px 20px;float:left;\"></div>");
      this.activeFiltering = {
        filters: {}
      };
      for (var i=0;i<this.featuresForViewer.length;i++) {
        if (Object.keys(this.featuresForViewer[i]).length !== 0) {
          var filter = this.featuresForViewer[i][Object.keys(this.featuresForViewer[i])[0]].filter;
          if (filter !== "none" && (!activeFiltering.filters[filter.split(" ").join("_")])) {
            var filterMin = filter.split(" ").join("_");
            this.activeFiltering.filters[filterMin]=filter;
            filterOptions[filterMin]=true;
          }
        }
      }
      },*/
      /* This should go to sequence viewer
      createSVG: function() {
        this.sequences.forEach(function (o) {
          if (o.uniqueName === this.isoName) {
            currentSeq = o.sequence;
            ft = new FeatureViewer(currentSeq, "#chart", {
              showAxis: true,
              showSequence: true,
              brushActive: true,
              toolbar:true,
              bubbleHelp:true,
              unit:"aa",
              zoomMax:10,
              toolbarTemplate: 2
            });
            seqView = new Sequence(currentSeq, this.isoName);
            seqView.render('#seqViewer', {
              'showLineNumbers': true,
              'wrapAminoAcids': true,
              'charsPerLine': 50,
              'search':true,
              'toolbar':true,
              'header':{
                'display':false,
                'searchInTitle': false,
                'unit': "aa",
                'showCpl':false,
                'badgeWithUnit':true
              }
            });

            //Customize Sequence viewer - raw version
            this.$$(".fasta-link").addAttribute("href","https://old.nextprot.org/db/entry/" + this.isoName.split("-")[0] + "/fasta?isoform=" + this.isoName.slice(3));
            $("#seqViewer").prepend("<div class='seqHeader'></div>");
            this.$$(".seqHeader").append("<div class=''><div class=''><strong>Isoform :</strong> " + o.mainEntityName.name + "</div></div>");
            this.$$(".seqHeader").append("<div class=''><div class=''> " + o.sequence.length + " aa</div></div>");
            this.$$(".seqHeader").append("<div class=''><div class=''><strong>Mass :</strong> " + o.massAsString + " Da</div></div>");
            this.$$(".seqHeader").append("<div class=''><div class=''><strong>pI :</strong> " + o.isoelectricPointAsString + "</div></div>");

            $("#seqViewer .inputSearchSeq").attr("placeholder","Search in sequence...");
            $("#seqViewer .inputSearchSeq").attr("data-toggle","tooltip");
            $("#seqViewer .inputSearchSeq").attr("data-placement","top");
            $("#seqViewer .inputSearchSeq").attr("title","Regex supported");

            $('#seqViewer [data-toggle="tooltip"]').tooltip();
          }
        });
      },*/
      /* move to triple viewer
      addFeatures: function() {
        for (var i=0;i<this.featuresForViewer.length;i++) {
          if (Object.keys(this.featuresForViewer[i]).length !== 0 && this.featuresForViewer[i].hasOwnProperty(isoName) && filterOptions[this.featuresForViewer[i][this.isoName].filter.split(" ").join("_")] === true) {
            var feature = jQuery.extend({}, this.featuresForViewer[i][this.isoName]);
            ft.addFeature(feature);
          }
        }
      },*/
      /*
      // move this to feature table
      fillTable: function() {
        function toggleEvidenceInfos() {
          $(".evidenceNumber").click(function () {
            $(this).parent().parent().next().toggle();
          })
        }

        if ($("#featuresTable").length > 0) {
          var number = 0;
          var features = {};
          this.featuresByIsoform.forEach( function (d) { if (d.hasOwnProperty(this.isoName)) {
            if(d[this.isoName]) {
              var group = d[this.isoName][0].group;
              if(Object.keys(features).indexOf(group)<0) {
                features[group] = {'group': group, 'features': [d[this.isoName]]};
              } else {
                features[group]['features'].push(d[this.isoName]);
              }
            }
          }});

          for (feat in this.featuresByIsoform) if(this.featuresByIsoform[feat].hasOwnProperty(this.isoName)) {
            number += this.featuresByIsoform[feat][this.isoName].length;
            for (var i=0;i<this.featuresByIsoform[feat][this.isoName].length;i++) if(this.featuresByIsoform[feat][this.isoName][i].source) {
              this.featuresByIsoform[feat][this.isoName][i].evidenceSources = getUniqueListOfEvidenceSources(this.featuresByIsoform[feat][this.isoName][i].source);
            }
          }
          var datas = {
            groupedFeatures: features,
            featuresLength: number
          };
          toggleEvidenceInfos();
        }
      },
      tvSelection: function() {
        $(".featPosition").click(function() {
          $(".tableHighlight").removeClass("tableHighlight");
          $(this).parent().parent().addClass("tableHighlight");
          var currentId = $(this).parent().parent().attr("id");
          var position = currentId.split("_").slice(1).map(Number);
          if (position.length === 1) position.push(position[0]);
            var svgId = "#" + "f" + currentId;

          position[0]-=1;
          seqView.selection(position[0],position[1],"#C50063");
          this.ft.addRectSelection(svgId);

          scrollAuto(".stringSelected", ".scroller",200);
        })
      },
      fvSelection: function(d) {
        seqView.selection(d.start - 1,d.end,"#C50063");
        var featSelectedID = "#" + d.id;
        $(".tableHighlight").removeClass("tableHighlight");
        $(featSelectedID).addClass("tableHighlight");

        scrollAuto(featSelectedID, "#featTableScroller",70);
        scrollAuto(".stringSelected", ".scroller",200);
      },
      eventTV: function() {
        this.ft.onFeatureSelected(function(d){
          this.fvSelection(d.detail);
        });
      }*/
      /* goes to triple viewer
      toggleFiltering: function() {
        $("#filtering label").mouseover(function(){
          var type=$(this).children("input").attr("id");
          ft.showFilteredFeature(type, "#795B42", document.location.href);
        });
        $("#filtering label").mouseout(function(){
          var type=$(this).children("input").attr("id");
          ft.hideFilteredFeature(type);
        });
        $("#allFilters").click(function(){
          if ($("#filtering").hasClass("all-filters")){

            $("#filtering input[type=checkbox]").prop("checked", false);

            console.log("has class all-filters");
            for(var key in filterOptions) {
              filterOptions[key] = false;
            }
            $("#filtering").removeClass("all-filters");
          }
          else {

            $("#filtering input[type=checkbox]").prop("checked", true);

            for(var key in filterOptions) {
              filterOptions[key] = true;
            }
            $("#filtering").addClass("all-filters");
          }
          applyFiltering();
          getInfoForIsoform.reloadSVG(isoName);

        })
        $("#filtering input:checkbox").on("change", function() {
          console.log("count the number of checkbox not checked : ");
          console.log($("#filtering input:checkbox:not(:checked)").length);

          if (!$("#filtering input:checkbox:not(:checked)").length) {
            console.log("all checkbox are checked");
            $("#filtering").addClass("all-filters");
          }
          else if (!$("#filtering input:checkbox:checked").length) {
            console.log("all checkbox are unchecked");
            $("#filtering").removeClass("all-filters");
          }
          else {
            $("#filtering").removeClass("all-filters");
          }filterOptions["none"] = true;
          applyFiltering();
          getInfoForIsoform.reloadSVG(isoName);
        });

      }*/
    });
  </script>
</dom-module>